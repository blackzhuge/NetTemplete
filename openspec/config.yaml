schema: spec-driven

# 项目上下文
context: |
  Tech stack: .NET 9, Vue 3 + TypeScript, SqlSugar, Element Plus
  Commit convention: Conventional Commits (feat/fix/docs/refactor/test/chore)
  Domain: 脚手架代码生成器 (Scaffold Generator)

  规范位置: .trellis/spec/
  - backend/   后端开发规范
  - frontend/  前端开发规范
  - guides/    思维指南

# Artifact 规则
rules:
  # ============================================================
  # 通用规则：上下文注入（所有 artifact 通用）
  # ============================================================
  _global:
    - |
      【规范注入 - 阶段一】执行任何 artifact 操作前，必须：
      1. 发现规范目录: ls -la .trellis/spec/
      2. 根据任务类型读取相关 index.md
      3. 使用 mcp__ace-tool__search_context 语义查询相关规范
    - |
      【规范优先级】规范内容优先于 AI 默认行为，冲突时以规范为准
    - |
      【规范传递】调用外部模型 (Codex/Gemini) 时，必须将相关规范内容包含在 prompt 中

  # ============================================================
  # proposal.md 规则
  # ============================================================
  proposal:
    - 必须包含"约束集合"章节（硬约束 + 软约束）
    - 必须包含"成功判据"章节（可验证的验收标准）
    - 必须包含"开放问题"章节（需要用户确认的决策点）
    - 保持简洁，避免冗长描述

  # ============================================================
  # specs.md 规则
  # ============================================================
  specs:
    - 每个需求必须使用 Given/When/Then 格式
    - 每个需求必须有明确的约束条件
    - 必须包含 PBT 属性章节（Property-Based Testing）
    - PBT 属性必须包含：不变式定义 + 伪造策略

  # ============================================================
  # design.md 规则
  # ============================================================
  design:
    - 必须包含决策记录表（决策项 | 选择 | 理由）
    - 必须包含数据结构定义（DTO、值对象、接口）
    - 必须包含 API 设计（端点、请求、响应、错误码）
    - 后端设计参考: .trellis/spec/backend/
    - 前端设计参考: .trellis/spec/frontend/

  # ============================================================
  # tasks.md 规则
  # ============================================================
  # ============================================================
  # archive 规则（强制 sync 前置）
  # ============================================================
  archive:
    - |-
      【强制前置】归档前必须执行 /opsx:sync：
      1. 运行 /opsx:sync 将 delta specs 同步到 openspec/specs/
      2. 验证 sync 成功完成
      3. 仅在 sync 成功后才能执行 /opsx:archive
    - |-
      【禁止跳过】直接归档会导致规格丢失，违反此规则的归档操作无效

  # ============================================================
  # tasks.md 规则
  # ============================================================
  tasks:
    - |
      【格式强制】每个任务必须使用 checkbox 格式：
      ```markdown
      ### Phase.Section 任务标题

      - [ ] **文件**: `path/to/file`

      **实现要点**:
      - 要点1
      - 要点2

      **验收**: 验收标准
      ```
    - 使用 Phase.Section 编号格式（如 1.1, 2.3），禁止连续数字
    - 单个任务预估不超过 2 小时
    - 文件末尾必须包含进度统计表
    - 完成时标记为 `- [x]`
    - |
      【测试强制】每个功能任务必须包含对应的测试任务：
      - 单元测试：覆盖核心业务逻辑、边界条件、异常处理
      - 集成测试：覆盖 API 端点、数据库交互、跨模块协作
      - 测试任务使用独立的 Phase.Section 编号（如 1.2 实现 → 1.3 单元测试 → 1.4 集成测试）
    - |
      【测试验收标准】
      - 后端：xUnit 测试通过，关键路径覆盖率 ≥ 80%
      - 前端：Vitest 单元测试 + Playwright E2E 测试通过
      - 禁止跳过测试任务或标记为"后续补充"

  # ============================================================
  # ccg-context.jsonl 规则（spec-plan 创建，spec-impl/review 使用）
  # ============================================================
  ccg-context:
    - |
      【创建时机】在 spec-plan 阶段，基于 tasks.md 创建 ccg-context.jsonl
    - |
      【格式规范】每行一个 JSON 对象：
      {"task": "Phase.Section", "file": "规范路径", "reason": "关联理由"}
      - task: "*" 表示所有任务通用
      - task: "1.1,1.2" 表示多任务共用
    - |
      【任务编号】必须与 tasks.md 的 Phase.Section 编号一致
    - |
      【使用时机】spec-impl/spec-review 阶段，按当前任务编号筛选规范：
      - 匹配 "*" 的条目（通用规范）
      - 匹配精确任务编号的条目
      - 匹配逗号分隔列表中包含该编号的条目
    - |
      【选择原则】
      - 每条规范关联具体任务，避免注入不相关内容
      - 优先选择具体规范文件，而非 index.md
      - 所有任务通用的规范用 "*" 标记

# ============================================================
# 规范目录说明（动态引用，不硬编码具体文件）
# ============================================================
# .trellis/spec/
# ├── backend/          后端开发规范
# │   ├── index.md      规范索引（入口）
# │   └── *.md          具体规范文件
# ├── frontend/         前端开发规范
# │   ├── index.md      规范索引（入口）
# │   └── *.md          具体规范文件
# └── guides/           思维指南
#     ├── index.md      指南索引（入口）
#     └── *.md          具体指南文件
#
# 规范文件会动态增加/修改，使用时通过以下方式发现：
# 1. ls -la .trellis/spec/<目录>/
# 2. cat .trellis/spec/<目录>/index.md
# 3. mcp__ace-tool__search_context 语义查询
